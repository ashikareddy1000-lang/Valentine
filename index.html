<script>
  (function initCuteVideoOpener(){
    const overlay = document.getElementById('cuteVideoOverlay');
    const video   = document.getElementById('cuteVideo');
    const playBtn = document.getElementById('playBtn');
    const skipBtn = document.getElementById('skipBtn');

    if(!overlay || !video) return;

    // Ensure attributes (in case markup changed)
    video.muted = true;
    video.setAttribute('muted','');
    video.setAttribute('playsinline','');
    video.setAttribute('webkit-playsinline','');
    video.setAttribute('autoplay','');
    video.preload = 'auto';
    // iOS sometimes needs a fresh load after setting attributes
    try { video.load(); } catch (e) {}

    let autoHideTimer = null;

    function tryPlay(label){
      const p = video.play?.();
      if(p && typeof p.then === 'function'){
        p.then(()=>{
          // success
          playBtn && (playBtn.style.display = 'none');
          // auto-hide after a bit
          startAutoHide();
        }).catch((err)=>{
          // blocked by policy: show Play button
          if(playBtn) playBtn.style.display = 'inline-flex';
          // console for debugging
          console.debug('[Video autoplay blocked]', label, err);
        });
      }else{
        // Older browsers: start auto-hide anyway
        startAutoHide();
      }
    }

    function startAutoHide(){
      if(autoHideTimer) return;
      autoHideTimer = setTimeout(hideOverlay, (window.CONFIG?.videoAutoHideMs ?? 5200));
    }

    function hideOverlay(){
      if(!overlay) return;
      overlay.style.opacity = '0';
      overlay.style.visibility = 'hidden';
      try { video.pause(); } catch(e) {}
      setTimeout(()=> overlay.remove(), 600);
    }

    // Attempt immediately
    tryPlay('initial');

    // Retry once the video has data
    video.addEventListener('loadeddata', ()=> tryPlay('loadeddata'), { once:true });

    // If tab becomes visible later, retry
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState === 'visible'){
        tryPlay('visibilitychange');
      }
    });

    // User-gesture fallback
    if(playBtn){
      playBtn.addEventListener('click', ()=>{
        video.muted = true; // keep muted to satisfy autoplay
        tryPlay('user-play');
      });
    }

    // Skip control
    if(skipBtn){
      skipBtn.addEventListener('click', ()=>{
        if(autoHideTimer) clearTimeout(autoHideTimer);
        hideOverlay();
      });
    }

    // As a last resort, allow touch on the overlay to trigger play (mobile)
    overlay.addEventListener('touchstart', ()=>{
      tryPlay('touchstart');
    }, { once:true });

    // Add a temporary control for debugging (remove later)
    // video.setAttribute('controls',''); // <- uncomment to see controls if you need to test quickly
  })();
</script>
